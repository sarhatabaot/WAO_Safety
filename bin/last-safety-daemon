#!/bin/bash

PROG=$(basename "${0}")
PID_FILE="/tmp/wao_safety.pid"
APP_DIR="$HOME/python/WAO_Safety"
MAIN_SCRIPT="$APP_DIR/main.py"

function usage() {
    echo "Usage:"
    echo "  ${PROG} start|stop|status|restart"
}

function is_running() {
    pgrep -f "WAO_Safety/main.py" >/dev/null
}

if [ ${#} -ne 1 ]; then
    usage
    exit 1
fi

case ${1} in
    start)
        if is_running; then
            echo "Service is already running"
            exit 0
        fi

        cd "$APP_DIR" || exit 1
        source venv/bin/activate
        nohup python3 "$MAIN_SCRIPT" >/dev/null 2>&1 &
        echo $! > "$PID_FILE"
        echo "Service started (PID: $!)"
        ;;

    stop)
        if [ -f "$PID_FILE" ]; then
            kill "$(cat "$PID_FILE")" 2>/dev/null
            rm -f "$PID_FILE"
        fi
        pkill -9 -f "WAO_Safety/main.py" 2>/dev/null
        echo "Service stopped"
        ;;

    status)
        if is_running; then
            echo "Service is running"
        else
            echo "Service is not running"
        fi
        ;;

    restart)
        $0 stop
        sleep 2
        $0 start
        ;;

    *)
        usage
        exit 1
        ;;
esac